generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FacilityType {
  clinic
  hospital
  pharmacy
  unknown
}

enum RecordType {
  dispensing_record
  prescription
}

enum CourseType {
  improving
  worsening
  no_change
  unknown
}

enum AdherenceType {
  yes
  partial
  no
  unknown
}

enum ReminderEventStatus {
  sent
  acknowledged
  skipped
}

enum VisitType {
  new_symptom
  followup
}

model Patient {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())

  // Phase 1 auth binding
  authProvider String?
  authSubject  String?

  // 비밀번호 인증 (phone + password)
  phoneE164     String?   @unique // E.164 형식 전화번호 (로그인 ID로 사용)
  passwordHash  String?   // bcrypt 해시된 비밀번호

  // 환자 기본 정보
  name              String?   // 환자 이름
  birthDate         DateTime? // 생년월일 (주민번호 대신)
  bloodType         String?   // 혈액형 (A+, B-, O+, AB- 등)
  heightCm          Float?    // 키 (cm)
  weightKg          Float?    // 몸무게 (kg)
  allergies         String?   // 알레르기 정보 (콤마 구분 또는 JSON)
  emergencyContact  String?   // 비상연락처

  records         PrescriptionRecord[]
  intakes         IntakeForm[]
  shareTokens     ShareToken[]
  reminders       Reminder[]
  dailyConditions DailyCondition[]

  @@index([name, birthDate]) // 아이디 찾기용 인덱스
}

model Facility {
  id        String       @id @default(uuid())
  name      String
  type      FacilityType @default(unknown)
  specialty String?      // 진료 과목 (이비인후과, 안과, 정형외과, 내과 등)
  address   String?      // 주소
  phone     String?      // 전화번호
  createdAt DateTime     @default(now())

  records   PrescriptionRecord[]
  intakes   IntakeForm[]
  shareTokens ShareToken[]

  @@index([name])
  @@index([specialty])
}

model PrescriptionRecord {
  id            String    @id @default(uuid())
  patientId     String
  patient       Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  facilityId    String?
  facility      Facility? @relation(fields: [facilityId], references: [id], onDelete: SetNull)

  recordType    RecordType

  chiefComplaint String?
  doctorDiagnosis String?
  noteDoctorSaid  String?

  prescribedAt    DateTime?
  dispensedAt     DateTime?
  daysSupply      Int?
  completionDate  DateTime?
  createdAt       DateTime @default(now())

  ocrExtraction    OcrExtraction?
  medItems         MedItem[]
  medicationChecks MedicationCheck[]
  dailyConditions  DailyCondition[]

  @@index([patientId, createdAt])
  @@index([chiefComplaint])
  @@index([completionDate])
}

model OcrExtraction {
  id                   String  @id @default(uuid())
  prescriptionRecordId String  @unique
  prescriptionRecord   PrescriptionRecord @relation(fields: [prescriptionRecordId], references: [id], onDelete: Cascade)

  rawText             String
  fieldsJson          Json?
  confidenceJson      Json?
  overallConfidence   Float?
  createdAt           DateTime @default(now())
}

model MedItem {
  id                   String  @id @default(uuid())
  prescriptionRecordId String
  prescriptionRecord   PrescriptionRecord @relation(fields: [prescriptionRecordId], references: [id], onDelete: Cascade)

  nameRaw             String
  dose                String?
  frequency           String?
  durationDays        Int?
  confidence          Float?
  needsVerification   Boolean @default(false)

  createdAt           DateTime @default(now())
}

model IntakeForm {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  facilityId  String?
  facility    Facility? @relation(fields: [facilityId], references: [id], onDelete: SetNull)

  visitType   VisitType @default(new_symptom) // 새로운 증상 or 이전 처방 관련
  relatedRecordId String? // 이전 처방 관련인 경우 연결된 PrescriptionRecord ID

  chiefComplaint String
  onsetAt        DateTime?
  onsetText      String?

  course         CourseType @default(unknown)
  courseNote     String?

  adherence      AdherenceType @default(unknown)
  adherenceReason String?

  adverseEvents  String?
  allergies      String?
  createdAt      DateTime @default(now())

  @@index([patientId, createdAt])
  @@index([relatedRecordId])
}

model ShareToken {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  facilityId  String?
  facility    Facility? @relation(fields: [facilityId], references: [id], onDelete: SetNull)

  tokenHash   String   @unique
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())

  accessLogs  AccessLog[]

  @@index([patientId, createdAt])
  @@index([expiresAt])
}

model AccessLog {
  id          String   @id @default(uuid())
  shareTokenId String
  shareToken   ShareToken @relation(fields: [shareTokenId], references: [id], onDelete: Cascade)

  accessedAt  DateTime @default(now())
  ipHash      String?
  userAgentHash String?
}

model Reminder {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  medNameRaw  String
  scheduleJson Json
  enabled     Boolean @default(true)
  createdAt   DateTime @default(now())

  events      ReminderEvent[]
}

model ReminderEvent {
  id          String   @id @default(uuid())
  reminderId  String
  reminder    Reminder @relation(fields: [reminderId], references: [id], onDelete: Cascade)

  scheduledAt DateTime
  status      ReminderEventStatus @default(sent)
  note        String?
}

enum ConditionStatus {
  improving
  same
  worsening
  fluctuating
}

model MedicationCheck {
  id                   String             @id @default(uuid())
  prescriptionRecordId String
  prescriptionRecord   PrescriptionRecord @relation(fields: [prescriptionRecordId], references: [id], onDelete: Cascade)

  scheduledAt DateTime
  takenAt     DateTime?
  isTaken     Boolean   @default(false)
  dayNumber   Int
  doseNumber  Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([prescriptionRecordId, scheduledAt])
  @@index([prescriptionRecordId])
}

model DailyCondition {
  id                   String             @id @default(uuid())
  patientId            String
  patient              Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)

  recordDate           DateTime
  status               ConditionStatus
  note                 String?
  prescriptionRecordId String?
  prescriptionRecord   PrescriptionRecord? @relation(fields: [prescriptionRecordId], references: [id], onDelete: SetNull)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@unique([patientId, recordDate])
  @@index([patientId])
}


