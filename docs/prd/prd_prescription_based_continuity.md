# PRD: 처방전/조제내역서 기반 연속진료 요약 (Draft v0.1)

## 0) 문서 상태

- 현재 문서는 **회의 기반 초안**이며, 법적 해석/적합성은 **전문 자문으로 확정**이 필요하다.
- 관련 합의/배경은 `docs/meeting_notes/2025-12-18_med_continuity_prescription_based.md` 참고.

## 1) 배경 / 문제

### 1.1 문제

- 지방(의료 접근성이 낮은 지역)에서는 의료기관/전문의 접근이 제한되어 환자가 **의원↔병원↔종합병원**을 이동하는 일이 잦다.
- 그런데 기관이 바뀌면 “A에서의 진료 맥락”이 B에 **자연스럽게 이어지지** 않는다. 특히 다음 정보가 끊긴다:
  - 최근 어떤 약을 **언제부터/얼마나/어떤 이유로** 복용했는지
  - 복용 이후 증상이 **어떻게 변화했는지(호전/악화/부작용/중단)**
- 그 결과 B기관에서는 제한된 진료 시간 안에 과거 정보를 다시 재구성해야 하고, 이는 다음 문제로 이어진다:
  - **안전 리스크**: 중복/유사 처방, 알레르기·부작용 히스토리 누락, 약력 오해
  - **진료 효율 저하**: 반복 문진, 추가 확인/재방문, 검사·처방 의사결정 지연
  - **환자 부담 증가**: 이동/대기 비용이 큰 환경에서 동일한 설명을 반복해야 하고, “기억 기반 전달”로 오류가 발생

#### 누가 겪는가

- **환자**: 이동 진료가 잦은 지방 거주자, 만성질환자/고령자/다약제 복용자, 타 지역 상급병원으로 전원·의뢰되는 환자
- **의료진**: 초진/재진에서 과거 약력·경과를 빠르게 파악해야 하는 B기관(의원/병원/종합병원) 의사·간호 인력

#### 현재의 불완전한 해결(왜 아직 문제인가)

- 환자는 처방전/조제내역서를 **종이로 들고 다니거나 사진첩에 저장**하거나, **기억에 의존**해 설명한다.
- 의료진 입장에서는 정보가 **비표준/비구조화**되어 즉시 활용하기 어렵고, 누락·왜곡 가능성이 크다.
- EMR 연동/기관 간 교류는 도입·계약·운영 복잡도가 높아 MVP로 바로 풀기 어렵다.

### 1.2 해결 가설

- **핵심 가설**: EMR 연동 없이도, 환자가 보유한 **처방전/조제내역서**와 대기 중 2~3분 입력한 **경과/복약/부작용**을
  “의료진이 즉시 읽을 수 있는 형태”로 **구조화·요약**하면 연속진료 품질이 올라간다.
- 우리가 해결하는 문제의 초점은 “진단을 대신”하는 것이 아니라,
  **다음 의료진의 ‘정보 공백’을 줄여 더 안전하고 빠른 진료 판단을 돕는 것**이다.
- MVP는 환자 주도로 공유하며, 의료진에게는 **90일 기본 1장 요약 + 원문 펼치기**를 제공한다.

## 2) 목표 / 비목표

### 2.1 목표

- 대기 중 2~3분 입력으로 **복약·경과 요약을 생성**하고,
  다음 의료진이 **1장 요약**으로 빠르게 파악한다.

### 2.2 비목표(초기)

- EMR/OCS 연동
- 응급 상황 커버
- 질환/진단 후보 추정(진단 지원)
- 병원 계정/로그인 기반 운영(MVP에서는 제외)
- 원본 이미지 장기 저장

## 3) 사용자 / 시나리오

### 3.1 주요 사용자

- 환자(앱)
- 의료진(열람 전용, MVP는 로그인 없음)

### 3.2 핵심 시나리오(대기실)

1. 환자: 앱에서 방문 병원 선택
2. 환자: 처방전/조제내역서 촬영(선택) + 문진/경과 설문(2~3분)
3. 환자: “의사에게 보여주기” → 1회성 QR/코드 생성
4. 의료진: QR/코드 스캔 → 1장 요약 열람 → 필요시 원문 펼치기

## 4) 제품 범위(기능 요구사항)

### 4.1 환자 앱

- 병원 검색/선택
- 문서 업로드(선택): 처방전/조제내역서
  - 온보딩 기본값(확정): **조제내역서 촬영을 1순위로 안내**(처방전은 선택/추가)
- 빠른 처방 기록: 접수 없이 처방전/조제내역서 사진만 업로드하여 약물 기록 저장
  - 용도: 과거 처방 기록 사전 등록, 접수 전 약물 정보 빠른 저장
  - 입력 항목: 사진, 병원/약국명(선택), 진단/증상(선택), 처방일(선택)
- 첫 결과 화면(결정): **현재 복용중 요약(A) + 복약 알림(C)**을 함께 제공
- 대기 중 설문(필수): 주증상/시작시점/경과/복약순응/부작용/알레르기/의사요지(환자메모)
- 공유: 1회성 QR/코드 생성, 만료/재발급
- 데이터 관리: 제출한 설문/약력 삭제(환자 권한)

### 4.2 의료진 화면(1장 요약)

- 요약 카드 + 섹션별 원문 펼치기
- 약력 타임라인 기간 토글: **30일/90일**, 기본값 **90일(확정)**
- OCR 불확실 항목 “확인 필요” 표시
- 열람 로그 표시(내부 운영용)

## 5) 데이터 / AI 정책

### 5.1 데이터 원칙

- 최소 수집/최소 보관
- 원본 이미지 **저장하지 않음**(MVP 결정)
  - 처리 방식(확정): **서버 업로드 → 즉시 OCR 처리 → 원본 이미지 즉시 삭제(무저장)**

### 5.2 AI 사용 원칙(MVP)

- **질환/진단 후보 제시 금지**
- 허용: OCR/정규화/요약/사실 기반 충돌 점검(확인 필요 수준)
  - 약품명 정규화 수준(MVP 확정): **A안(OCR 문자열 그대로, 성분/제품명 매핑 없음)**
- 벤더(결정):
  - OCR: **Google Cloud Vision**
  - LLM(선택): **Google Gemini** (요약/분류/체크리스트 생성 용도, 진단 추정 금지)
- 모든 출력은 **출처 라벨링**(환자 작성 / OCR 추출 / 시스템 계산)

## 6) 보안 / 개인정보 / 동의(초안)

- 건강정보(민감정보) 취급 전제로 설계
- 동의 UX:
  - 수집·이용(항목/목적/보관기간)
  - 제3자 제공(환자가 선택한 병원/의료진에게 제공, 제공 항목/기간)
  - 철회/삭제(환자)
- 접근통제:
  - 1회성 토큰, TTL(**기본 10분(확정)**), 재발급 시 이전 토큰 폐기
    - 1회성 토큰 규칙(확정): **TTL(10분) 내 재열람 허용**, TTL 만료 시 열람 불가
    - 재발급 규칙(확정): **환자만 재발급 가능**, 재발급 즉시 이전 토큰 폐기
  - 전송/저장 암호화
  - 감사 로그(열람/생성/삭제)

## 7) 성공지표(KPI) 초안

- 대기 중 설문 완료율
- 의료진 열람률(QR 스캔률)
- 평균 생성/열람 시간(“1장 요약”까지)
- 의료진 만족도(정성)
- 재사용률(다음 방문에서 다시 사용)

## 8) 롤아웃 / 단계

### Phase 0 (MVP)

- 문서 OCR(무저장) + 대기실 설문 + 1장 요약 + QR 공유

### Phase 1

- 약품 정규화/성분 매핑 고도화
- 질문 개인화(길이/분기 최적화)
- 의료진 로그인 도입(운영 안정화)
- (추가 기능) OTC(일반의약품) 복약편의 보조
  - 입력: **처방약 효능군 기반**으로 “약국에서 활용 가능한 OTC 카테고리”를 제시(사용자 목표=복약 편의)
  - 출력: **제품명(브랜드) 추천은 하지 않고**, 효능군/카테고리 수준의 안내 + “약사에게 확인할 질문/주의 체크리스트” 제공
  - 가드레일: “대체 가능/동일 효과” 등 단정 표현 금지, 중복복용/상호작용 가능성은 “확인 필요”로만 표시

### Phase 2 (선택)

- 공공/표준 연계 검토(HIE/마이데이터 등) 또는 EMR 연동 협의

## 9) 리스크 / 대응

- OCR 정확도: 불확실 표시 + 환자/의료진 확인 UX
- 로그인 없는 열람 보안: 1회성/짧은 TTL/재발급 폐기/로그
- 환자 메모 오해: “환자 작성” 출처 라벨 + 의료진 확인 유도

## 10) 미결정 질문(다음 회의에서 확정)

- (해결) OCR 처리 방식: **서버 즉시 처리(무저장)**
  - (해결) 약품명 정규화 수준(MVP): **A안(OCR 원문 그대로)**
- 설문 문항/분기(최소 2분 내 완료) 확정
- 의료진 화면 정보 필드(고정) 최종 확정

## 11) 추가 구현 기능 (MVP 확장)

> 아래 항목은 **MVP 출시 이후** 단계적으로 추가한다. (MVP는 로그인 없이 QR/코드 공유 중심)

### 11.1 환자 인증

- **Google 로그인(OAuth)** + **휴대폰 로그인(SMS OTP)** 지원
- 세션 기반 인증 (PostgreSQL 세션 스토어)
- 비로그인 사용자용 랜딩 페이지 분리

### 11.2 빠른 처방 기록 (Quick Prescription Recording)

- 접수 없이 처방전/조제내역서 이미지를 **빠르게 등록**하는 단축 워크플로우
- 3단계 프로세스:
  1. 사진 업로드 후 **“분석하기”** 클릭
  2. OCR 결과 검토 (약물명, 용량, 신뢰도 점수, 처방일/조제일 확인)
  3. 병원명/약국명(선택), 증상(선택), 진단명(선택) 입력 (처방일 자동 입력)
- OCR 미리보기 API: **저장 전 추출 결과를 검토**할 수 있도록 제공

### 11.3 증상별 과거 기록 조회

- 같은 증상(`chiefComplaint`)으로 과거 진료받은 기록 조회
- 해당 증상에서 사용된 약물 통계(빈도 등) 표시

### 11.4 알림 시스템

- 복약 알림, 재진료 알림, 의료진 조회 알림
- 알림 설정 관리(켜기/끄기)
- 읽음 처리 기능

### 11.5 진단명 필드 추가

- 처방 기록에 의사 진단명(`doctorDiagnosis`) 필드 추가
- “빠른 처방 기록”에서 입력 가능

### 11.6 OCR 신뢰도 표시 강화

- 80% 미만 신뢰도 항목에 **“검증 필요”** 뱃지 표시
- 신뢰도 분포 시각화
